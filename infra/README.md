# Welcome to your CDK TypeScript project

This is a blank project for CDK development with TypeScript.

The `cdk.json` file tells the CDK Toolkit how to execute your app.

## Useful commands

- `npm run build` compile typescript to js
- `npm run watch` watch for changes and compile
- `npm run test` perform the jest unit tests
- `npx cdk deploy` deploy this stack to your default AWS account/region
- `npx cdk diff` compare deployed stack with current state
- `npx cdk synth` emits the synthesized CloudFormation template

## Edge Auth Config

The Lambda@Edge auth code reads Cognito settings from a local JSON file:

`infra/main/edge-auth-config.json`

This file is generated by the deployment script in the `tonitassani-sites` repo and is ignored by git. The expected shape is:

```json
{
  "region": "eu-west-2",
  "userPoolId": "eu-west-2_example",
  "domain": "https://example.auth.eu-west-2.amazoncognito.com",
  "clientId": "exampleclientid",
  "redirectSignIn": "https://humblyproud.com/studio",
  "redirectSignOut": "https://humblyproud.com/studio",
  "learningStateTable": "studio-learning-state",
  "learningStateRegion": "eu-west-2",
  "userIdentityAdminTable": "studio-user-identity-admin",
  "userIdentityAdminRegion": "eu-west-2"
}
```

For learning state persistence, the edge runtime can also read:
- `STUDIO_LEARNING_STATE_TABLE`
- `STUDIO_LEARNING_STATE_REGION`

For optional admin/support mapping (`sub` -> `lastKnownEmail`), edge runtime can also read:
- `STUDIO_USER_IDENTITY_ADMIN_TABLE`
- `STUDIO_USER_IDENTITY_ADMIN_REGION`

Notes:
- `userIdentityAdminTable` and `userIdentityAdminRegion` are optional.
- If they are present, `/studio/learning-state` PUT performs a best-effort upsert of `userId` + `lastKnownEmail` + `updatedAt`.
- Failures on this admin upsert do not block the primary learning-state write.
